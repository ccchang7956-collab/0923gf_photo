<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>災害通報系統 - 資料上傳</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    <!-- 標題 -->
    <div class="bg-blue-600 text-white p-6 rounded-t-lg shadow-lg">
      <h1 class="text-2xl font-bold text-center">花蓮縣光復鄉災害通報系統</h1>
      <p class="text-center mt-2 text-blue-100">資料上傳</p>
    </div>

    <!-- 導航 -->
    <div class="bg-white p-4 shadow">
      <div class="flex justify-center space-x-4">
        <button class="bg-blue-600 text-white px-4 py-2 rounded font-semibold">上傳資料</button>
        <a href="?page=query" class="bg-gray-300 text-gray-700 px-4 py-2 rounded font-semibold">查詢資料</a>
      </div>
    </div>

    <!-- 表單 -->
    <div class="bg-white p-6 rounded-b-lg shadow-lg">
      <form id="uploadForm">
        <!-- 基本資料 -->
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">基本資料</h2>
          
          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">姓名 <span class="text-red-500">*</span></label>
            <input type="text" id="name" required 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">電話 <span class="text-red-500">*</span></label>
            <input type="tel" id="phone" required pattern="[0-9]{10}"
                   placeholder="請輸入10碼電話號碼"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">信箱</label>
            <input type="email" id="email"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <!-- 地址資料 -->
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">地址資料</h2>
          
          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">村 <span class="text-red-500">*</span></label>
            <select id="village" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">請選擇村</option>
              <option value="大安村">大安村</option>
              <option value="大華村">大華村</option>
              <option value="大平村">大平村</option>
              <option value="大馬村">大馬村</option>
              <option value="大同村">大同村</option>
              <option value="東富村">東富村</option>
              <option value="北富村">北富村</option>
            </select>
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">鄰 <span class="text-red-500">*</span></label>
            <input type="number" id="neighborhood" required min="1"
                   placeholder="請輸入鄰數"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">詳細地址 <span class="text-red-500">*</span></label>
            <input type="text" id="address" required
                   placeholder="例：中正路123號"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>

          <div class="bg-blue-50 p-3 rounded-lg">
            <p class="text-sm text-gray-600">完整地址預覽：</p>
            <p id="fullAddressPreview" class="text-blue-700 font-semibold mt-1">花蓮縣光復鄉...</p>
          </div>
        </div>

        <!-- 照片上傳 -->
        <div class="mb-6">
          <h2 class="text-xl font-bold mb-4 text-gray-700 border-b pb-2">照片上傳（最多5張）</h2>
          
          <input type="file" id="imageInput" accept="image/*" multiple 
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
          
          <div id="imagePreview" class="grid grid-cols-2 gap-4"></div>
        </div>

        <!-- 進度條 -->
        <div id="progressContainer" class="mb-6 hidden">
          <div class="bg-gray-200 rounded-full h-6 overflow-hidden">
            <div id="progressBar" class="bg-blue-600 h-full transition-all duration-300 flex items-center justify-center text-white text-sm font-semibold">
              0%
            </div>
          </div>
          <p id="progressText" class="text-center mt-2 text-gray-600"></p>
        </div>

        <!-- 提交按鈕 -->
        <button type="submit" id="submitBtn"
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-blue-700 transition duration-300">
          送出資料
        </button>
      </form>
    </div>

    <!-- 成功訊息 -->
    <div id="successMessage" class="hidden mt-6 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
      <p class="font-bold">上傳成功！</p>
      <p id="recordIdDisplay"></p>
    </div>

    <!-- 錯誤訊息 -->
    <div id="errorMessage" class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
      <p class="font-bold">發生錯誤</p>
      <p id="errorText"></p>
    </div>
  </div>

  <script>
    let selectedImages = [];

    // 地址預覽更新
    function updateAddressPreview() {
      const village = document.getElementById('village').value;
      const neighborhood = document.getElementById('neighborhood').value;
      const address = document.getElementById('address').value;
      
      let preview = '花蓮縣光復鄉';
      if (village) preview += village;
      if (neighborhood) preview += neighborhood + '鄰';
      if (address) preview += address;
      
      document.getElementById('fullAddressPreview').textContent = preview;
    }

    document.getElementById('village').addEventListener('change', updateAddressPreview);
    document.getElementById('neighborhood').addEventListener('input', updateAddressPreview);
    document.getElementById('address').addEventListener('input', updateAddressPreview);

    // 圖片選擇處理
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const files = Array.from(e.target.files).slice(0, 5);
      selectedImages = [];
      const previewContainer = document.getElementById('imagePreview');
      previewContainer.innerHTML = '';

      files.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(event) {
          selectedImages.push(event.target.result);
          
          const imgContainer = document.createElement('div');
          imgContainer.className = 'relative';
          imgContainer.innerHTML = `
            <img src="${event.target.result}" class="w-full h-40 object-cover rounded-lg border-2 border-gray-300">
            <div class="absolute top-2 right-2 bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">
              ${index + 1}
            </div>
            <button type="button" onclick="removeImage(${index})" 
                    class="absolute top-2 left-2 bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-700">
              ×
            </button>
          `;
          previewContainer.appendChild(imgContainer);
        };
        
        reader.readAsDataURL(file);
      });
    });

    // 移除圖片
    window.removeImage = function(index) {
      selectedImages.splice(index, 1);
      document.getElementById('imageInput').value = '';
      const event = new Event('change');
      document.getElementById('imageInput').dispatchEvent(event);
    };

    // 表單提交
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // 隱藏訊息
      document.getElementById('successMessage').classList.add('hidden');
      document.getElementById('errorMessage').classList.add('hidden');
      
      // 顯示進度條
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const submitBtn = document.getElementById('submitBtn');
      
      progressContainer.classList.remove('hidden');
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
      
      try {
        // 驗證照片
        if (selectedImages.length === 0) {
          throw new Error('請至少上傳一張照片');
        }
        
        // 更新進度
        updateProgress(10, '準備上傳資料...');
        
        // 使用 google.script.run 來呼叫伺服端函數
        updateProgress(30, '處理資料...');
        
        // 準備資料物件
        const uploadData = {
          name: document.getElementById('name').value,
          phone: document.getElementById('phone').value,
          email: document.getElementById('email').value,
          village: document.getElementById('village').value,
          neighborhood: document.getElementById('neighborhood').value,
          address: document.getElementById('address').value,
          images: selectedImages
        };
        
        updateProgress(50, '上傳中...');
        
        // 使用 google.script.run 呼叫後端
        google.script.run
          .withSuccessHandler(function(result) {
            updateProgress(100, '完成！');
            
            if (result.success) {
              document.getElementById('successMessage').classList.remove('hidden');
              document.getElementById('recordIdDisplay').textContent = `您的編號：${result.recordId}`;
              document.getElementById('uploadForm').reset();
              document.getElementById('imagePreview').innerHTML = '';
              selectedImages = [];
              updateAddressPreview();
              
              setTimeout(() => {
                progressContainer.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
              }, 2000);
            } else {
              throw new Error(result.message);
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('errorText').textContent = error.message || '上傳失敗，請稍後再試';
            progressContainer.classList.add('hidden');
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          })
          .submitUpload(uploadData);
        
      } catch (error) {
        document.getElementById('errorMessage').classList.remove('hidden');
        document.getElementById('errorText').textContent = error.message;
        progressContainer.classList.add('hidden');
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    });

    function updateProgress(percent, text) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
      progressText.textContent = text;
    }
  </script>
</body>
</html>