<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ç½å®³é€šå ±ç³»çµ± - è³‡æ–™ä¸Šå‚³</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* è‡ªå®šç¾©æ¨£å¼ */
    .card {
      background-color: white;
      border-radius: 0.75rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      border: 1px solid #f3f4f6;
    }
    .input-field {
      width: 100%;
      padding: 1rem;
      font-size: 1.125rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      outline: none;
      transition: all 0.2s;
    }
    .input-field:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .btn-primary {
      width: 100%;
      background-color: #2563eb;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: bold;
      font-size: 1.125rem;
      transition: all 0.2s;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border: none;
      cursor: pointer;
    }
    .btn-primary:hover {
      background-color: #1d4ed8;
    }
    .btn-primary:active {
      background-color: #1e40af;
    }
    .btn-secondary {
      background-color: #f3f4f6;
      color: #374151;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .btn-secondary:hover {
      background-color: #e5e7eb;
    }
    .btn-secondary:active {
      background-color: #d1d5db;
    }
    .label {
      display: block;
      color: #374151;
      font-weight: bold;
      margin-bottom: 0.75rem;
      font-size: 1.125rem;
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: #1f2937;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e5e7eb;
    }
    /* æ‰‹æ©Ÿå°ˆç”¨æ¨£å¼ */
    @media (max-width: 640px) {
      .container {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      .card {
        margin-left: 0.25rem;
        margin-right: 0.25rem;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-gray-100 min-h-screen">
  <!-- æ‰‹æ©Ÿç‰ˆæ¨™é¡Œå¡ç‰‡ -->
  <div class="sticky top-0 z-40 bg-white shadow-lg">
    <div class="container mx-auto px-4 py-4">
      <div class="text-center">
        <h1 class="text-xl font-bold text-blue-600">ğŸš¨ ç½å®³é€šå ±ç³»çµ±</h1>
        <p class="text-sm text-gray-600">èŠ±è“®ç¸£å…‰å¾©é„‰ - è³‡æ–™ä¸Šå‚³</p>
      </div>
      
      <!-- å°èˆªæŒ‰éˆ• -->
      <div class="flex mt-4 gap-2">
        <button class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold text-sm">
          ğŸ“¤ ä¸Šå‚³è³‡æ–™
        </button>
        <a href="?page=query" class="flex-1 btn-secondary text-center py-2 px-4 text-sm">
          ğŸ” æŸ¥è©¢è³‡æ–™
        </a>
      </div>
    </div>
  </div>

  <div class="container mx-auto px-4 py-6 pb-20">
    <!-- ä¸»è¡¨å–®å¡ç‰‡ -->
    <div class="card p-6 mb-6">
      <form id="uploadForm" class="space-y-6">
        
        <!-- åŸºæœ¬è³‡æ–™å¡ç‰‡ -->
        <div class="card p-5 bg-blue-50 border-blue-200">
          <h2 class="section-title text-blue-800">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h2>
          
          <div class="space-y-4">
            <div>
              <label class="label">
                å§“å <span class="text-red-500">*</span>
              </label>
              <input type="text" id="name" required class="input-field" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            </div>

            <div>
              <label class="label">
                é›»è©± <span class="text-red-500">*</span>
              </label>
              <input type="tel" id="phone" required pattern="[0-9]{10}" class="input-field" 
                     placeholder="0912345678" inputmode="numeric">
              <p class="text-sm text-gray-500 mt-1">è«‹è¼¸å…¥10ç¢¼é›»è©±è™Ÿç¢¼</p>
            </div>

            <div>
              <label class="label">ä¿¡ç®±</label>
              <input type="email" id="email" class="input-field" placeholder="your@email.com">
            </div>
          </div>
        </div>

        <!-- åœ°å€è³‡æ–™å¡ç‰‡ -->
        <div class="card p-5 bg-green-50 border-green-200">
          <h2 class="section-title text-green-800">ğŸ“ åœ°å€è³‡æ–™</h2>
          
          <div class="space-y-4">
            <div>
              <label class="label">
                æ‘ <span class="text-red-500">*</span>
              </label>
              <select id="village" required class="input-field bg-white">
                <option value="">ğŸ˜ï¸ è«‹é¸æ“‡æ‘</option>
                <option value="å¤§å®‰æ‘">å¤§å®‰æ‘</option>
                <option value="å¤§è¯æ‘">å¤§è¯æ‘</option>
                <option value="å¤§å¹³æ‘">å¤§å¹³æ‘</option>
                <option value="å¤§é¦¬æ‘">å¤§é¦¬æ‘</option>
                <option value="å¤§åŒæ‘">å¤§åŒæ‘</option>
                <option value="æ±å¯Œæ‘">æ±å¯Œæ‘</option>
                <option value="åŒ—å¯Œæ‘">åŒ—å¯Œæ‘</option>
              </select>
            </div>

            <div>
              <label class="label">
                é„° <span class="text-red-500">*</span>
              </label>
              <input type="number" id="neighborhood" required min="1" max="50" 
                     class="input-field" placeholder="è«‹è¼¸å…¥é„°æ•¸" inputmode="numeric">
            </div>

            <div>
              <label class="label">
                è©³ç´°åœ°å€ <span class="text-red-500">*</span>
              </label>
              <input type="text" id="address" required class="input-field" 
                     placeholder="ä¾‹ï¼šä¸­æ­£è·¯123è™Ÿ">
            </div>

            <!-- åœ°å€é è¦½å¡ç‰‡ -->
            <div class="card p-4 bg-gradient-to-r from-green-100 to-blue-100 border-green-300">
              <p class="text-sm font-semibold text-gray-700 mb-1">ğŸ“ å®Œæ•´åœ°å€é è¦½ï¼š</p>
              <p id="fullAddressPreview" class="text-green-700 font-bold text-lg">èŠ±è“®ç¸£å…‰å¾©é„‰...</p>
            </div>
          </div>
        </div>

        <!-- ç…§ç‰‡ä¸Šå‚³å¡ç‰‡ -->
        <div class="card p-5 bg-yellow-50 border-yellow-200">
          <h2 class="section-title text-yellow-800">ğŸ“¸ ç…§ç‰‡ä¸Šå‚³ï¼ˆæœ€å¤š5å¼µï¼‰</h2>
          
          <!-- ç…§ç‰‡é¸æ“‡æŒ‰éˆ• -->
          <div class="mb-4">
            <label for="imageInput" class="block">
              <div class="card p-6 border-2 border-dashed border-yellow-400 bg-yellow-100 hover:bg-yellow-200 transition-colors cursor-pointer text-center">
                <div class="text-4xl mb-2">ğŸ“·</div>
                <p class="font-bold text-yellow-800">é»æ“Šé¸æ“‡ç…§ç‰‡</p>
                <p class="text-sm text-yellow-700 mt-1">æ”¯æ´å¤šé¸ï¼Œæœ€å¤š5å¼µ</p>
              </div>
            </label>
            <input type="file" id="imageInput" accept="image/*" multiple class="hidden" capture="environment">
          </div>
          
          <!-- ç…§ç‰‡é è¦½å€ -->
          <div id="imagePreview" class="grid grid-cols-2 gap-3"></div>
          
          <!-- ç…§ç‰‡æ•¸é‡æç¤º -->
          <div id="imageCount" class="mt-3 text-center text-sm text-gray-600 hidden">
            å·²é¸æ“‡ <span id="imageCountNumber">0</span> å¼µç…§ç‰‡
          </div>
        </div>

        <!-- æäº¤æŒ‰éˆ• -->
        <div class="pt-4">
          <button type="submit" id="submitBtn" class="btn-primary">
            ğŸš€ é€å‡ºè³‡æ–™
          </button>
        </div>
      </form>
    </div>

    <!-- é€²åº¦å¡ç‰‡ -->
    <div id="progressCard" class="card p-6 mb-6 hidden">
      <h3 class="text-lg font-bold text-center mb-4">ğŸ“¤ ä¸Šå‚³é€²åº¦</h3>
      
      <!-- é€²åº¦æ¢ -->
      <div class="bg-gray-200 rounded-full h-8 overflow-hidden mb-3">
        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-full transition-all duration-500 flex items-center justify-center text-white font-bold">
          0%
        </div>
      </div>
      
      <!-- é€²åº¦æ–‡å­— -->
      <p id="progressText" class="text-center text-gray-600 font-semibold">æº–å‚™ä¸­...</p>
      
      <!-- è¼‰å…¥å‹•ç•« -->
      <div class="flex justify-center mt-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    </div>

    <!-- æˆåŠŸè¨Šæ¯å¡ç‰‡ -->
    <div id="successCard" class="card p-6 mb-6 hidden bg-green-50 border-green-200">
      <div class="text-center">
        <div class="text-6xl mb-4">âœ…</div>
        <h3 class="text-xl font-bold text-green-800 mb-2">ä¸Šå‚³æˆåŠŸï¼</h3>
        <div class="card p-4 bg-white border-2 border-green-300">
          <p class="font-bold text-gray-700">æ‚¨çš„ç·¨è™Ÿï¼š</p>
          <p id="recordIdDisplay" class="text-2xl font-bold text-green-600"></p>
        </div>
        <p class="text-sm text-green-700 mt-3">è«‹è¨˜ä½æ­¤ç·¨è™Ÿï¼Œä»¥ä¾¿æ—¥å¾ŒæŸ¥è©¢</p>
      </div>
    </div>

    <!-- éŒ¯èª¤è¨Šæ¯å¡ç‰‡ -->
    <div id="errorCard" class="card p-6 mb-6 hidden bg-red-50 border-red-200">
      <div class="text-center">
        <div class="text-6xl mb-4">âŒ</div>
        <h3 class="text-xl font-bold text-red-800 mb-2">ç™¼ç”ŸéŒ¯èª¤</h3>
        <div class="card p-4 bg-white border-2 border-red-300">
          <p id="errorText" class="text-red-700"></p>
        </div>
        <button onclick="hideError()" class="mt-4 bg-red-600 text-white py-2 px-6 rounded-lg">
          é‡æ–°å˜—è©¦
        </button>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨å®‰å…¨å€åŸŸ -->
  <div class="h-8"></div>

  <script>
    let selectedImages = [];

    // åœ°å€é è¦½æ›´æ–°
    function updateAddressPreview() {
      const village = document.getElementById('village').value;
      const neighborhood = document.getElementById('neighborhood').value;
      const address = document.getElementById('address').value;
      
      let preview = 'èŠ±è“®ç¸£å…‰å¾©é„‰';
      if (village) preview += village;
      if (neighborhood) preview += neighborhood + 'é„°';
      if (address) preview += address;
      
      document.getElementById('fullAddressPreview').textContent = preview;
    }

    // ç¶å®šåœ°å€è®Šæ›´äº‹ä»¶
    document.getElementById('village').addEventListener('change', updateAddressPreview);
    document.getElementById('neighborhood').addEventListener('input', updateAddressPreview);
    document.getElementById('address').addEventListener('input', updateAddressPreview);

    // æ›´æ–°ç…§ç‰‡æ•¸é‡é¡¯ç¤º
    function updateImageCount() {
      const countElement = document.getElementById('imageCount');
      const numberElement = document.getElementById('imageCountNumber');
      
      if (selectedImages.length > 0) {
        countElement.classList.remove('hidden');
        numberElement.textContent = selectedImages.length;
      } else {
        countElement.classList.add('hidden');
      }
    }

    // åœ–ç‰‡é¸æ“‡è™•ç†
    document.getElementById('imageInput').addEventListener('change', function(e) {
      const files = Array.from(e.target.files).slice(0, 5);
      selectedImages = [];
      const previewContainer = document.getElementById('imagePreview');
      previewContainer.innerHTML = '';

      if (files.length === 0) {
        updateImageCount();
        return;
      }

      files.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(event) {
          selectedImages.push(event.target.result);
          
          const imgContainer = document.createElement('div');
          imgContainer.className = 'relative group';
          imgContainer.innerHTML = `
            <div class="card overflow-hidden">
              <img src="${event.target.result}" class="w-full h-32 object-cover">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200"></div>
              <div class="absolute top-2 right-2 bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm shadow-lg">
                ${index + 1}
              </div>
              <button type="button" onclick="removeImage(${index})" 
                      class="absolute top-2 left-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-600 active:bg-red-700 transition-colors shadow-lg">
                Ã—
              </button>
            </div>
            <p class="text-xs text-gray-600 mt-1 truncate px-1">${file.name}</p>
          `;
          previewContainer.appendChild(imgContainer);
          updateImageCount();
        };
        
        reader.readAsDataURL(file);
      });
    });

    // ç§»é™¤åœ–ç‰‡
    window.removeImage = function(index) {
      selectedImages.splice(index, 1);
      
      // é‡æ–°è§¸ç™¼ change äº‹ä»¶ä¾†æ›´æ–°é è¦½
      const imageInput = document.getElementById('imageInput');
      const dt = new DataTransfer();
      
      // é‡æ–°å»ºç«‹æª”æ¡ˆåˆ—è¡¨ï¼ˆæ’é™¤è¢«ç§»é™¤çš„æª”æ¡ˆï¼‰
      Array.from(imageInput.files).forEach((file, i) => {
        if (i !== index) {
          dt.items.add(file);
        }
      });
      
      imageInput.files = dt.files;
      imageInput.dispatchEvent(new Event('change', { bubbles: true }));
    };

    // éš±è—éŒ¯èª¤è¨Šæ¯
    window.hideError = function() {
      document.getElementById('errorCard').classList.add('hidden');
    };

    // é¡¯ç¤º/éš±è—å¡ç‰‡
    function showCard(cardId) {
      document.getElementById(cardId).classList.remove('hidden');
      // å¹³æ»‘æ»¾å‹•åˆ°å¡ç‰‡
      document.getElementById(cardId).scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
    }

    function hideCard(cardId) {
      document.getElementById(cardId).classList.add('hidden');
    }

    // æ›´æ–°é€²åº¦
    function updateProgress(percent, text) {
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
      progressText.textContent = text;
    }

    // è¡¨å–®æäº¤
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // éš±è—æ‰€æœ‰è¨Šæ¯å¡ç‰‡
      hideCard('successCard');
      hideCard('errorCard');
      
      // é¡¯ç¤ºé€²åº¦å¡ç‰‡
      showCard('progressCard');
      
      // ç¦ç”¨æäº¤æŒ‰éˆ•
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-50');
      submitBtn.innerHTML = 'â³ ä¸Šå‚³ä¸­...';
      
      try {
        // é©—è­‰ç…§ç‰‡
        if (selectedImages.length === 0) {
          throw new Error('è«‹è‡³å°‘ä¸Šå‚³ä¸€å¼µç…§ç‰‡');
        }
        
        // æ›´æ–°é€²åº¦
        updateProgress(10, 'ğŸ“‹ é©—è­‰è³‡æ–™...');
        
        // æº–å‚™è³‡æ–™
        updateProgress(30, 'ğŸ“¦ æº–å‚™ä¸Šå‚³...');
        
        const uploadData = {
          name: document.getElementById('name').value,
          phone: document.getElementById('phone').value,
          email: document.getElementById('email').value,
          village: document.getElementById('village').value,
          neighborhood: document.getElementById('neighborhood').value,
          address: document.getElementById('address').value,
          images: selectedImages
        };
        
        updateProgress(50, 'â˜ï¸ ä¸Šå‚³ä¸­...');
        
        // ä½¿ç”¨ google.script.run å‘¼å«å¾Œç«¯
        google.script.run
          .withSuccessHandler(function(result) {
            updateProgress(100, 'âœ… å®Œæˆï¼');
            
            setTimeout(() => {
              hideCard('progressCard');
              
              if (result.success) {
                showCard('successCard');
                document.getElementById('recordIdDisplay').textContent = result.recordId;
                
                // é‡è¨­è¡¨å–®
                document.getElementById('uploadForm').reset();
                document.getElementById('imagePreview').innerHTML = '';
                selectedImages = [];
                updateImageCount();
                updateAddressPreview();
                
              } else {
                showCard('errorCard');
                document.getElementById('errorText').textContent = result.message;
              }
              
              // æ¢å¾©æäº¤æŒ‰éˆ•
              submitBtn.disabled = false;
              submitBtn.classList.remove('opacity-50');
              submitBtn.innerHTML = 'ğŸš€ é€å‡ºè³‡æ–™';
              
            }, 1000);
          })
          .withFailureHandler(function(error) {
            hideCard('progressCard');
            showCard('errorCard');
            document.getElementById('errorText').textContent = error.message || 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
            
            // æ¢å¾©æäº¤æŒ‰éˆ•
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50');
            submitBtn.innerHTML = 'ğŸš€ é€å‡ºè³‡æ–™';
          })
          .submitUpload(uploadData);
        
      } catch (error) {
        hideCard('progressCard');
        showCard('errorCard');
        document.getElementById('errorText').textContent = error.message;
        
        // æ¢å¾©æäº¤æŒ‰éˆ•
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-50');
        submitBtn.innerHTML = 'ğŸš€ é€å‡ºè³‡æ–™';
      }
    });

    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      updateAddressPreview();
      updateImageCount();
      
      // é˜²æ­¢iOS Safariçš„å½ˆè·³æ•ˆæœ
      document.addEventListener('touchmove', function(e) {
        if (!e.target.closest('.overflow-auto')) {
          e.preventDefault();
        }
      }, { passive: false });
    });
  </script>
</body>
</html>